
data "aws_ssoadmin_instances" "myidstore" {}

# identity store id and ARN
locals {
  identity_store_id = tolist(data.aws_ssoadmin_instances.myidstore.identity_store_ids)[0]
  identity_store_arn = tolist(data.aws_ssoadmin_instances.myidstore.arns)[0]
}

output "identity_store_id" {
  value = local.identity_store_id
}


# # Create an IAM Identity Center group for Management Account Administrators
# # AWS does not recommend as a best practice to use a group for Management Account
# # This needs to be visited later to see if we can avoid this.
# # We need this group / users to create workload accounts via Terraform
# resource "aws_identitystore_group" "management_administrators_group" {
#   identity_store_id = local.identity_store_id
#   display_name      = "Management Administrators"
#   description       = "Management Administrator group"
# }

# Create an IAM Identity Center group for DelegatedAdmin Account Administrators
resource "aws_identitystore_group" "delegatedadmin_administrators_group" {
  identity_store_id = local.identity_store_id
  display_name      = "DelegatedAdmin Administrators"
  description       = "DelegatedAdmin Administrator group"
}

# Create an IAM Identity Center group for Security Logging Account Administrators
resource "aws_identitystore_group" "security_administrators_group" {
  identity_store_id = local.identity_store_id
  display_name      = "Security Administrators"
  description       = "Security Administrator group"
}

# Create an IAM Identity Center group for Infrastructure Account Administrators
resource "aws_identitystore_group" "infrastructure_administrators_group" {
  identity_store_id = local.identity_store_id
  display_name      = "Infrastructure Administrators"
  description       = "Infrastructure Administrator group"
}

# Create an IAM Identity Center group for Billing Administrators
resource "aws_identitystore_group" "billing_administrators_group" {
  identity_store_id = local.identity_store_id
  display_name      = "Billing Administrators"
  description       = "Billing Administrator group"
}

# Create an IAM Identity Center group for Security Analysts
resource "aws_identitystore_group" "security_analysts_group" {
  identity_store_id = local.identity_store_id
  display_name      = "Security Analysts"
  description       = "Security Analyst group"
}

########### Permission sets for Administrators #############
resource "aws_ssoadmin_permission_set" "administrator" {
  name             = "Administrator"
  description      = "Provides administrator access to AWS resources"
  instance_arn     = local.identity_store_arn
  session_duration = "PT1H" # 1 hours session duration (ISO-8601 standard)
}

# Attach the AdministratorAccess IAM managed policy to the permission set created above
# For now, we use the same policy for all Administrator Groups. This can be 
# customized later as needed.
resource "aws_ssoadmin_managed_policy_attachment" "admin_policy_attach" {
  instance_arn       = local.identity_store_arn
  permission_set_arn = aws_ssoadmin_permission_set.administrator.arn
  # The ARN for the built-in AdministratorAccess policy
  managed_policy_arn = "arn:aws:iam::aws:policy/AdministratorAccess"
}


########### Permission sets for Billing Administrators #############
resource "aws_ssoadmin_permission_set" "billing" {
  name             = "Billing"
  description      = "Provides billing access to AWS resources"
  instance_arn     = local.identity_store_arn
  session_duration = "PT2H" # 1 hours session duration (ISO-8601 standard)
}

# Attach the Billing IAM managed policy to the permission set created above
resource "aws_ssoadmin_managed_policy_attachment" "billing_policy_attach" {
  instance_arn       = local.identity_store_arn
  permission_set_arn = aws_ssoadmin_permission_set.billing.arn
  # The ARN for the built-in Billing policy
  managed_policy_arn = "arn:aws:iam::aws:policy/job-function/Billing"
}


########### Permission sets for Security Analysts #############
resource "aws_ssoadmin_permission_set" "securityanalyst" {
  name             = "SecurityAnalyst"
  description      = "Provides security analyst access to AWS resources"
  instance_arn     = local.identity_store_arn
  session_duration = "PT2H" # 1 hours session duration (ISO-8601 standard)
}

# Attach the Security Analyst IAM managed policy to the permission set created above
resource "aws_ssoadmin_managed_policy_attachment" "security_analyst_policy_attach" {
  instance_arn       = local.identity_store_arn
  permission_set_arn = aws_ssoadmin_permission_set.securityanalyst.arn
  # The ARN for the built-in Security Analyst policy
  managed_policy_arn = "arn:aws:iam::aws:policy/job-function/ViewOnlyAccess"
}




########################## users creation ####################################
## Now create the first user in Identity Center
## If moving to SSO from external identity provider, this step is not needed.
resource "aws_identitystore_user" "admin_user" {
  identity_store_id = local.identity_store_id
  user_name         = "user1_admin1"
  display_name      = "Admin1 User1"
  name {
    given_name  = "Admin1"
    family_name = "User1"
  }
  emails {
    value      = var.user1_admin1_email
    type       = "work"
    primary    = true
  }
}
#############################################################################


######################################################################
# Administrator permission and user assignment to Management Account
# Administrator PERMISSION SET and GROUP ASSIGNMENT TO DelegatedAdmin,
# SecurityLogging, and Infrastructure ACCOUNTS
######################################################################

# Assign the permission set to the Management Administrators Group in Management Account
resource "aws_ssoadmin_account_assignment" "management_administrator_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.administrator.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_user.admin_user.user_id

  # The type of principal (must be GROUP)
  principal_type = "USER"

  # The ID of the target AWS account
  target_id = var.management_account_id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the DelegatedAdmin Administrators Group in DelegatedAdminAccount
resource "aws_ssoadmin_account_assignment" "delegatedadmin_administrator_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.administrator.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.delegatedadmin_administrators_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.delegated_admin_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the Security Administrators Group in Security Logging Account
resource "aws_ssoadmin_account_assignment" "security_administrator_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.administrator.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.security_administrators_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.security_logging_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the Infrastructure Administrators Group in Infrastructure Account
resource "aws_ssoadmin_account_assignment" "infrastructure_administrator_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.administrator.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.infrastructure_administrators_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.infrastructure_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}



######################################################################
# Security Analyst permission and user assignment to Management Account
# Security Analyst PERMISSION SET and GROUP ASSIGNMENT TO DelegatedAdmin,
# SecurityLogging, and Infrastructure ACCOUNTS
######################################################################

# Assign the permission set to the Management Administrators Group in Management Account
resource "aws_ssoadmin_account_assignment" "management_securityanalyst_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.securityanalyst.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_user.admin_user.user_id

  # The type of principal (must be GROUP)
  principal_type = "USER"

  # The ID of the target AWS account
  target_id = var.management_account_id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the Security Analysts Group in DelegatedAdminAccount
resource "aws_ssoadmin_account_assignment" "delegatedadmin_securityanalyst_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.securityanalyst.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.security_analysts_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.delegated_admin_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the Security Analysts Group in Security Logging Account
resource "aws_ssoadmin_account_assignment" "securitylogging_securityanalyst_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.securityanalyst.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.security_analysts_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.security_logging_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}

# Assign the permission set to the Security Analysts Group in Infrastructure Account
resource "aws_ssoadmin_account_assignment" "infrastructure_securityanalyst_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.securityanalyst.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_group.security_analysts_group.group_id

  # The type of principal (must be GROUP)
  principal_type = "GROUP"

  # The ID of the target AWS account
  target_id = aws_organizations_account.infrastructure_account.id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}


######################################################################
# Billing permission and user assignment to Management Account
######################################################################

# Assign the permission set to the Management Administrators Group in Management Account
resource "aws_ssoadmin_account_assignment" "management_billing_assignment" {
  # The ARN of the SSO instance
  instance_arn = local.identity_store_arn

  # The ARN of the permission set
  permission_set_arn = aws_ssoadmin_permission_set.billing.arn

  # The ID of the principal (group)
  principal_id = aws_identitystore_user.admin_user.user_id

  # The type of principal (must be GROUP)
  principal_type = "USER"

  # The ID of the target AWS account
  target_id = var.management_account_id

  # The type of target (must be AWS_ACCOUNT)
  target_type = "AWS_ACCOUNT"
}



########### users assignment to groups #############
# # Add the user to the Management Administrators group
# resource "aws_identitystore_group_membership" "management_administrators_group_membership" {
#   identity_store_id = local.identity_store_id
#   group_id          = aws_identitystore_group.management_administrators_group.group_id
#   member_id         = aws_identitystore_user.admin_user.user_id
# }

# Add the user to the DelegatedAdmin Administrators group
resource "aws_identitystore_group_membership" "delegatedadmin_administrators_group_membership" {
  identity_store_id = local.identity_store_id
  group_id          = aws_identitystore_group.delegatedadmin_administrators_group.group_id
  member_id         = aws_identitystore_user.admin_user.user_id
}

# Add the user to the Security Administrators group
resource "aws_identitystore_group_membership" "security_administrators_group_membership" {
  identity_store_id = local.identity_store_id
  group_id          = aws_identitystore_group.security_administrators_group.group_id
  member_id         = aws_identitystore_user.admin_user.user_id
}

# Add the user to the Infrastructure Administrators group
resource "aws_identitystore_group_membership" "infrastructure_administrators_group_membership" {
  identity_store_id = local.identity_store_id
  group_id          = aws_identitystore_group.infrastructure_administrators_group.group_id
  member_id         = aws_identitystore_user.admin_user.user_id
}

# Add the user to the Security Analyst group
resource "aws_identitystore_group_membership" "security_analyst_group_membership" {
  identity_store_id = local.identity_store_id
  group_id          = aws_identitystore_group.security_analysts_group.group_id
  member_id         = aws_identitystore_user.admin_user.user_id
}

# Add the user to the Billing group
resource "aws_identitystore_group_membership" "billing_group_membership" {
  identity_store_id = local.identity_store_id
  group_id          = aws_identitystore_group.billing_administrators_group.group_id
  member_id         = aws_identitystore_user.admin_user.user_id
}